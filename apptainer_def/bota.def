Bootstrap: docker
From: debian:12-slim

%labels
    Author      HPC Admin - Kennedy Institute of Rheumatology, Oxford
    Description BOTA: Bacteria Originated T-Cell Antigen Predictor
    Version     2.0
    Python      2.7.18 (compiled from source)
    Keras       1.2.2 (Theano 0.9.0 backend)
    Base        Debian 12 (bookworm)

%help
    BOTA: Predicting Bacteria-origined T-cell antigens.
    Python 2.7.18 compiled from source on Debian 12.

    Bundled tools:
        HMMER  3.3.2       (/opt/hmmer/bin/)
        BLAT   36x2        (/usr/local/bin/blat)
        Prodigal 2.6.3     (/usr/local/bin/prodigal)

    Bind-mount at runtime (not bundled):
        HMMTOP:  --bind /path/to/hmmtop:/usr/local/hmmtop
        PSORTb:  --bind /path/to/psortb/bin:/usr/local/psortb/bin

    Basic usage:
        apptainer exec \
            --bind /path/to/pfam:/opt/BOTA/db/... \  # (use wrapper script)
            --bind /path/to/models:/opt/BOTA/models \
            bota.sif python2.7 /opt/BOTA/BOTA.py [options]

    Use the 'bota' wrapper script for convenience.

%environment
    export PATH=/opt/BOTA:/opt/python27/bin:/opt/hmmer/bin:/usr/local/hmmtop:/usr/local/psortb/bin:$PATH
    export LD_LIBRARY_PATH=/opt/python27/lib:$LD_LIBRARY_PATH
    export LC_ALL=C
    export LANG=C
    # Keras 1.2.2 backend configuration
    export KERAS_BACKEND=theano

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C

    # ------------------------------------------------------------------ #
    # Base build dependencies
    # ------------------------------------------------------------------ #
    apt-get update -y
    apt-get install -y --no-install-recommends \
        build-essential \
        wget \
        git \
        ca-certificates \
        pkg-config \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        libreadline-dev \
        libsqlite3-dev \
        libffi-dev \
        liblzma-dev \
        libncurses5-dev \
        libgdbm-dev \
        libgomp1 \
        perl
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # ------------------------------------------------------------------ #
    # Python 2.7.18 — compiled from source
    # ------------------------------------------------------------------ #
    cd /tmp
    wget -q --no-check-certificate \
        https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz
    tar xzf Python-2.7.18.tgz
    cd Python-2.7.18
    ./configure \
        --prefix=/opt/python27 \
        --enable-shared \
        --enable-unicode=ucs4 \
        --with-ensurepip=install \
        LDFLAGS="-Wl,-rpath=/opt/python27/lib"
    make -j$(nproc)
    make install
    cd /
    rm -rf /tmp/Python-2.7.18 /tmp/Python-2.7.18.tgz

    ln -sf /opt/python27/bin/python2.7 /usr/local/bin/python2.7
    ln -sf /opt/python27/bin/python2.7 /usr/local/bin/python2
    ln -sf /opt/python27/bin/python2.7 /usr/local/bin/python
    ln -sf /opt/python27/bin/pip2.7    /usr/local/bin/pip2.7
    ln -sf /opt/python27/bin/pip2.7    /usr/local/bin/pip

    # ------------------------------------------------------------------ #
    # pip bootstrap
    # ------------------------------------------------------------------ #
    wget -q --no-check-certificate \
        https://bootstrap.pypa.io/pip/2.7/get-pip.py \
        -O /tmp/get-pip.py
    python2.7 /tmp/get-pip.py "pip==20.3.4" "setuptools==44.1.1" "wheel==0.37.1"
    rm /tmp/get-pip.py

    # ------------------------------------------------------------------ #
    # Python libraries
    #
    # Keras 1.2.2 requires Theano 0.9.0 as backend
    # numpy 1.16.6 — last Python 2.7 compatible
    # scipy 1.2.3  — last Python 2.7 compatible
    # h5py  2.10.0 — last Python 2.7 compatible (Keras uses for model I/O)
    # pyyaml 3.13  — last version with Python 2.7 support; Keras dep
    # biopython 1.76, networkx 2.2 — last Python 2.7 compatible
    # ------------------------------------------------------------------ #
    python2.7 -m pip install \
        "numpy==1.16.6" \
        "scipy==1.2.3" \
        "h5py==2.10.0" \
        "pyyaml==3.13" \
        "biopython==1.76" \
        "networkx==2.2" \
        "theano==0.9.0" \
        "keras==1.2.2"

    # Configure Keras 1.2.2 to use Theano backend
    mkdir -p /etc/keras
    cat > /etc/keras/keras.json << 'KERASJSON'
{
    "floatx": "float32",
    "epsilon": 1e-07,
    "backend": "theano",
    "image_dim_ordering": "th"
}
KERASJSON
    # Keras 1.x reads from ~/.keras/keras.json; create a global one for root
    mkdir -p /root/.keras
    cp /etc/keras/keras.json /root/.keras/keras.json

    # ------------------------------------------------------------------ #
    # HMMER 3.3.2
    # ------------------------------------------------------------------ #
    cd /tmp
    wget -q http://eddylab.org/software/hmmer/hmmer-3.3.2.tar.gz
    tar xzf hmmer-3.3.2.tar.gz
    cd hmmer-3.3.2
    ./configure --prefix=/opt/hmmer
    make -j$(nproc)
    make install
    cd /
    rm -rf /tmp/hmmer-3.3.2 /tmp/hmmer-3.3.2.tar.gz

    # ------------------------------------------------------------------ #
    # Prodigal 2.6.3 — precompiled Linux binary
    # ------------------------------------------------------------------ #
    wget -q \
        https://github.com/hyattpd/Prodigal/releases/download/v2.6.3/prodigal.linux \
        -O /usr/local/bin/prodigal
    chmod +x /usr/local/bin/prodigal

    # ------------------------------------------------------------------ #
    # BLAT — UCSC precompiled Linux x86_64 binary
    # Free for academic/nonprofit use; see http://www.kentinformatics.com
    # for commercial licensing.
    # ------------------------------------------------------------------ #
    wget -q \
        https://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/blat/blat \
        -O /usr/local/bin/blat
    chmod +x /usr/local/bin/blat

    # ------------------------------------------------------------------ #
    # HMMTOP — not freely redistributable; placeholder only.
    # Bind-mount your licensed copy at /usr/local/hmmtop at runtime.
    # ------------------------------------------------------------------ #
    mkdir -p /usr/local/hmmtop

    # ------------------------------------------------------------------ #
    # PSORTb 3.0 — placeholder only.
    # Bind-mount your installation at /usr/local/psortb at runtime.
    # ------------------------------------------------------------------ #
    mkdir -p /usr/local/psortb/bin

    # ------------------------------------------------------------------ #
    # BOTA
    # ------------------------------------------------------------------ #
    cd /opt
    git clone https://bitbucket.org/luo-chengwei/BOTA.git \
        || git clone https://github.com/luo-chengwei/BOTA.git \
        || { echo "WARNING: BOTA clone failed - bind-mount source at /opt/BOTA"; mkdir -p /opt/BOTA; }

    [ -f /opt/BOTA/BOTA.py ] && chmod +x /opt/BOTA/BOTA.py || true
    ln -sf /opt/BOTA/BOTA.py /usr/local/bin/BOTA.py

    # NOTE: Do NOT use 'rm -rf /tmp/*' here — in fakeroot builds /tmp is not
    # namespaced and it will attempt to delete the host's /tmp.

%runscript
    exec python2.7 /opt/BOTA/BOTA.py "$@"

%test
    echo "=== Python 2.7 ==="
    python2.7 --version

    echo "=== NumPy ==="
    python2.7 -c "import numpy; print('NumPy', numpy.__version__)"

    echo "=== Keras ==="
    python2.7 -c "import keras; print('Keras', keras.__version__)"

    echo "=== BioPython ==="
    python2.7 -c "import Bio; print('BioPython', Bio.__version__)"

    echo "=== NetworkX ==="
    python2.7 -c "import networkx; print('NetworkX', networkx.__version__)"

    echo "=== HMMER ==="
    /opt/hmmer/bin/hmmbuild -h 2>&1 | head -2

    echo "=== Prodigal ==="
    prodigal -v 2>&1 | head -2

    echo "=== BLAT ==="
    blat 2>&1 | head -2 || true

    echo "=== BOTA ==="
    [ -f /opt/BOTA/BOTA.py ] \
        && echo "OK: BOTA.py found at /opt/BOTA/BOTA.py" \
        || echo "WARNING: BOTA.py not found"
